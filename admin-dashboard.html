<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
 <!-- ØªØ±Ù…ÙŠØ² Ø§Ù„Ø£Ø­Ø±Ù -->
    <meta charset="UTF-8">

    <!-- ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© -->
    <title>Jomaro Restaurant and Cafe - Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø§Øª ÙˆØ§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª</title>

    <!-- ÙˆØµÙ Ø§Ù„ØµÙØ­Ø© -->
    <meta name="description" content="Ù…Ø·Ø¹Ù… ÙˆÙƒØ§ÙÙŠÙ‡ Ø¬ÙˆÙ…Ø§Ø±Ùˆ - Ù…ÙƒØ§Ù†Ùƒ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ø§Ø³ØªÙ…ØªØ§Ø¹ Ø¨Ø£Ø·Ø¨Ø§Ù‚ Ù„Ø°ÙŠØ°Ø© ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª ÙØ§Ø®Ø±Ø© ÙÙŠ Ø£Ø¬ÙˆØ§Ø¡ Ø£Ù†ÙŠÙ‚Ø©. Ø§Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„ØªÙƒ Ø§Ù„Ø¢Ù†!">

    <!-- Ù…ÙŠØªØ§ Ø§Ù„Ø±ÙˆØ¨ÙˆØªØ§Øª -->
    <meta name="robots" content="index, follow">

    <!-- Ø±Ø§Ø¨Ø· ÙƒØ§Ù†ÙˆÙ†ÙŠÙƒØ§Ù„ -->
    <link rel="canonical" href="https://example.com/this-page">

    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Favicon) -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://drive.google.com/uc?export=download&id=1sEuWkLCp-o1BWqcDyhol0q8NbbcbRKN9">
    <link rel="icon" type="image/png" sizes="16x16" href="https://drive.google.com/uc?export=download&id=1sEuWkLCp-o1BWqcDyhol0q8NbbcbRKN9">

    <!-- Open Graph Tags (Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ ÙÙŠØ³Ø¨ÙˆÙƒØŒ ÙˆØ§ØªØ³Ø§Ø¨ØŒ Ø¥Ù„Ø®) -->
    <meta property="og:title" content="Jomaro Restaurant and Cafe">
    <meta property="og:description" content="Ù…Ø·Ø¹Ù… ÙˆÙƒØ§ÙÙŠÙ‡ Ø¬ÙˆÙ…Ø§Ø±Ùˆ - Ù…ÙƒØ§Ù†Ùƒ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ø§Ø³ØªÙ…ØªØ§Ø¹ Ø¨Ø£Ø·Ø¨Ø§Ù‚ Ù„Ø°ÙŠØ°Ø© ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª ÙØ§Ø®Ø±Ø© ÙÙŠ Ø£Ø¬ÙˆØ§Ø¡ Ø£Ù†ÙŠÙ‚Ø©.">
    <meta property="og:image" content="https://drive.google.com/uc?export=download&id=1sEuWkLCp-o1BWqcDyhol0q8NbbcbRKN9">
    <meta property="og:url" content="https://example.com/this-page">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_AR">

    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Jomaro Restaurant and Cafe">
    <meta name="twitter:description" content="Ù…Ø·Ø¹Ù… ÙˆÙƒØ§ÙÙŠÙ‡ Ø¬ÙˆÙ…Ø§Ø±Ùˆ - Ù…ÙƒØ§Ù†Ùƒ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ø§Ø³ØªÙ…ØªØ§Ø¹ Ø¨Ø£Ø·Ø¨Ø§Ù‚ Ù„Ø°ÙŠØ°Ø© ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª ÙØ§Ø®Ø±Ø© ÙÙŠ Ø£Ø¬ÙˆØ§Ø¡ Ø£Ù†ÙŠÙ‚Ø©.">
    <meta name="twitter:image" content="https://drive.google.com/uc?export=download&id=1sEuWkLCp-o1BWqcDyhol0q8NbbcbRKN9">
    <meta name="twitter:site" content="@your_twitter_handle"> <!-- Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ø§Ø³Ù… Ø­Ø³Ø§Ø¨Ùƒ Ø¹Ù„Ù‰ ØªÙˆÙŠØªØ± -->

    <!-- Ù„ÙˆÙ† Ø§Ù„Ø«ÙŠÙ… Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø© -->
    <meta name="theme-color" content="#d62828"> <!-- Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…Ø·Ø§Ø¹Ù… -->

    <!-- Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù Ø£Ùˆ Ø§Ù„Ø´Ø±ÙƒØ© -->
    <meta name="author" content="Jomaro Restaurant and Cafe">

    <!-- ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù„Ø§ ØªØ¤Ø«Ø± ÙÙŠ SEO Ù„ÙƒÙ† Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§) -->
    <meta name="keywords" content="Ù…Ø·Ø¹Ù…, ÙƒØ§ÙÙŠÙ‡, Ø¬ÙˆÙ…Ø§Ø±Ùˆ, Ø·Ø¹Ø§Ù…, Ù…Ø´Ø±ÙˆØ¨Ø§Øª, Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„Ø©, Ù…Ø£ÙƒÙˆÙ„Ø§Øª, Ø´ÙŠØ´Ø©, Ù‚Ù‡ÙˆØ©, Ø­Ù„ÙˆÙŠØ§Øª">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© - Ø¬ÙˆÙ…Ø§Ø±Ùˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="script/admin-dashboard.css">
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h2>
                <div class="sidebar-actions">
                    <button class="delete-all-btn" id="deleteAllConversations" title="Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª">
                        <i class="fas fa-trash-alt"></i> Ø­Ø°Ù Ø§Ù„ÙƒÙ„
                    </button>
                </div>
            </div>
            <div class="online-status" id="adminStatus">
                <div class="status-dot"></div>
                <span>Ø£Ù†Øª Ù…ØªØµÙ„</span>
            </div>
            <div class="customers-list" id="customersList">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ -->
            </div>
        </div>
        <div class="main-chat">
            <div class="chat-header">
                <div class="chat-header-info">
                    <h1 id="currentCustomerName">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©</h1>
                    <div class="customer-details" id="customerDetails">
                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ -->
                         <div class="tabs">
                            <button class="tab-btn"  onclick="window.open('adman.html', '_blank')">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
                        </div>
                    </div>
                </div>
                <div class="controls">
                    <button class="control-btn" id="toggleOnline" title="ØªØºÙŠÙŠØ± Ø­Ø§Ù„ØªÙƒ">
                        <i class="fas fa-toggle-on"></i>
                    </button>
                    <button class="control-btn" id="refreshBtn" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="messages-area" id="messagesArea">
                <div class="no-conversation">
                    <div>
                        <i class="fas fa-comments"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø®ØªØ§Ø±Ø©</p>
                        <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©</p>
                    </div>
                </div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <span></span><span></span><span></span>
            </div>
            <div class="input-area">
                <div class="reply-preview" id="replyPreview">
                    <span id="replyPreviewText">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰: ...</span>
                    <span class="cancel-reply" id="cancelReply">âœ•</span>
                </div>
                <div class="input-row">
                    <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..." maxlength="500" disabled>
                    <button id="sendButton" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script>
     // ØªÙƒÙˆÙŠÙ† Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDIs4dsxIk0xtuUaTGkIlVGKuFqwHBfr7g",
    authDomain: "app-da684.firebaseapp.com",
    projectId: "app-da684",
    storageBucket: "app-da684.firebasestorage.app",
    messagingSenderId: "204039458597",
    appId: "1:204039458597:web:5be11d7494ac10cb3314cc"
};
// ØªÙ‡ÙŠØ¦Ø© Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
// Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
let currentConversationId = null;
let isAdminOnline = true;
let currentReplyTo = null;
let currentCustomerData = null;
const customersList = document.getElementById('customersList');
const messagesArea = document.getElementById('messagesArea');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const currentCustomerName = document.getElementById('currentCustomerName');
const customerDetails = document.getElementById('customerDetails');
const typingIndicator = document.getElementById('typingIndicator');
const toggleOnlineBtn = document.getElementById('toggleOnline');
const refreshBtn = document.getElementById('refreshBtn');
const adminStatus = document.getElementById('adminStatus');
const replyPreview = document.getElementById('replyPreview');
const replyPreviewText = document.getElementById('replyPreviewText');
const cancelReply = document.getElementById('cancelReply');
const deleteAllBtn = document.getElementById('deleteAllConversations'); // Ø²Ø± Ø­Ø°Ù Ø§Ù„ÙƒÙ„

// ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙƒÙ…ØªØµÙ„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
db.ref('chat/adminOnline').set(true);

// ========== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ==========

// ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
toggleOnlineBtn.addEventListener('click', () => {
    isAdminOnline = !isAdminOnline;
    db.ref('chat/adminOnline').set(isAdminOnline);
    toggleOnlineBtn.innerHTML = isAdminOnline ? 
        '<i class="fas fa-toggle-on"></i>' : 
        '<i class="fas fa-toggle-off"></i>';
    adminStatus.innerHTML = isAdminOnline ? 
        '<div class="status-dot"></div><span>Ø£Ù†Øª Ù…ØªØµÙ„</span>' : 
        '<div class="status-dot" style="background: var(--offline);"></div><span>Ø£Ù†Øª ØºÙŠØ± Ù…ØªØµÙ„</span>';
    if (!isAdminOnline) {
        document.querySelector('.sidebar-header').classList.add('admin-offline');
    } else {
        document.querySelector('.sidebar-header').classList.remove('admin-offline');
    }
});

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§
refreshBtn.addEventListener('click', () => {
    loadConversations();
    showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª!');
});

// Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
deleteAllBtn.addEventListener('click', () => {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
        db.ref('chat/conversations').remove()
            .then(() => {
                showNotification('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                customersList.innerHTML = '';
                messagesArea.innerHTML = `
                    <div class="no-conversation">
                        <div>
                            <i class="fas fa-comments"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø®ØªØ§Ø±Ø©</p>
                            <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©</p>
                        </div>
                    </div>
                `;
                currentConversationId = null;
                currentCustomerData = null;
                currentCustomerName.textContent = 'Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©';
                customerDetails.innerHTML = '';
                messageInput.disabled = true;
                sendButton.disabled = true;
            })
            .catch((error) => {
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª: ' + error.message);
                console.error("Error deleting conversations: ", error);
            });
    }
});

// ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª (Ù…Ø¹Ø¯Ù‘Ù„Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
function loadConversations() {
    // Ø£ÙˆÙ„Ø§Ù‹: ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    db.ref('chat/conversations').once('value').then((snapshot) => {
        customersList.innerHTML = '';
        const conversations = snapshot.val();
        if (conversations) {
            Object.entries(conversations).forEach(([convId, convData]) => {
                createCustomerItem(convId, convData);
            });
        }
    });
    // Ø«Ø§Ù†ÙŠØ§Ù‹: Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©
    db.ref('chat/conversations').on('child_changed', (snapshot) => {
        const convId = snapshot.key;
        const convData = snapshot.val();
        updateCustomerItem(convId, convData);
    });
    // Ø«Ø§Ù„Ø«Ø§Ù‹: Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    db.ref('chat/conversations').on('child_added', (snapshot) => {
        const convId = snapshot.key;
        const convData = snapshot.val();
        // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ (Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±)
        if (!document.getElementById(`customer-${convId}`)) {
            createCustomerItem(convId, convData);
        }
    });
    // Ø±Ø§Ø¨Ø¹Ø§Ù‹: Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
    db.ref('chat/conversations').on('child_removed', (snapshot) => {
        const convId = snapshot.key;
        const customerElement = document.getElementById(`customer-${convId}`);
        if (customerElement) {
            customerElement.remove();
        }
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ù‡ÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ Ù‚Ù… Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        if (convId === currentConversationId) {
            messagesArea.innerHTML = `
                <div class="no-conversation">
                    <div>
                        <i class="fas fa-comments"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø®ØªØ§Ø±Ø©</p>
                        <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©</p>
                    </div>
                </div>
            `;
            currentConversationId = null;
            currentCustomerData = null;
            currentCustomerName.textContent = 'Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©';
            customerDetails.innerHTML = '';
            messageInput.disabled = true;
            sendButton.disabled = true;
        }
    });
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
function createCustomerItem(convId, convData) {
    const customerItem = document.createElement('div');
    customerItem.className = 'customer-item';
    customerItem.id = `customer-${convId}`;
    if (convId === currentConversationId) {
        customerItem.classList.add('active');
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©
    let hasNewMessages = false;
    if (convData.messages) {
        const messageKeys = Object.keys(convData.messages);
        if (messageKeys.length > 0) {
            const lastMessage = convData.messages[messageKeys[messageKeys.length - 1]];
            if (lastMessage.sender === 'customer' && !lastMessage.read) {
                hasNewMessages = true;
            }
        }
    }

    // Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø¨Ø¹Ø¯ 30 Ø¯Ù‚ÙŠÙ‚Ø©)
    const isCustomerOnline = convData.lastActive && (Date.now() - convData.lastActive < 30 * 60 * 1000);
    const statusClass = isCustomerOnline ? 'status-online' : 'status-offline';
    const statusText = isCustomerOnline ? 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†' : 'ØºÙŠØ± Ù…ØªØµÙ„';

    // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
    customerItem.innerHTML = `
        <div class="customer-info">
            <div class="customer-name">
                <span>${convData.customerName || 'Ø¹Ù…ÙŠÙ„ Ù…Ø¬Ù‡ÙˆÙ„'}</span>
                <span class="customer-status-badge ${statusClass}" title="${statusText}"></span>
            </div>
            <div class="customer-preview">${convData.lastMessage || 'Ø¨Ø¯Ø£Øª Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©'}</div>
            <div class="customer-time">
                <i class="far fa-clock"></i>
                ${formatTime(convData.lastActive || convData.startedAt)}
            </div>
        </div>
        <button class="delete-conversation-btn" title="Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">
            <i class="fas fa-trash"></i>
        </button>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    if (hasNewMessages) {
        const badge = document.createElement('div');
        badge.className = 'new-message-badge';
        badge.innerHTML = '!';
        customerItem.appendChild(badge);
    }

    // Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    customerItem.querySelector('.customer-info').addEventListener('click', (e) => {
        // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Ù‚Ø± Ù„Ù… ÙŠÙƒÙ† Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø­Ø°Ù
        if (!e.target.closest('.delete-conversation-btn')) {
            selectConversation(convId, convData);
        }
    });

    // Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø­Ø°Ù
    const deleteBtn = customerItem.querySelector('.delete-conversation-btn');
    deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Ù…Ù†Ø¹ Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£Ø¨
        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù…Ø­Ø§Ø¯Ø«Ø© "${convData.customerName || 'Ø¹Ù…ÙŠÙ„ Ù…Ø¬Ù‡ÙˆÙ„'}"ØŸ`)) {
            deleteConversation(convId, convData.customerName);
        }
    });

    customersList.appendChild(customerItem);
}

// Ø­Ø°Ù Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§Ø­Ø¯Ø©
function deleteConversation(convId, customerName) {
    db.ref(`chat/conversations/${convId}`).remove()
        .then(() => {
            showNotification(`ØªÙ… Ø­Ø°Ù Ù…Ø­Ø§Ø¯Ø«Ø© ${customerName || 'Ø§Ù„Ø¹Ù…ÙŠÙ„'} Ø¨Ù†Ø¬Ø§Ø­!`);
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
            const customerElement = document.getElementById(`customer-${convId}`);
            if (customerElement) {
                customerElement.remove();
            }
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ù‡ÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ Ù‚Ù… Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            if (convId === currentConversationId) {
                messagesArea.innerHTML = `
                    <div class="no-conversation">
                        <div>
                            <i class="fas fa-comments"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø®ØªØ§Ø±Ø©</p>
                            <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©</p>
                        </div>
                    </div>
                `;
                currentConversationId = null;
                currentCustomerData = null;
                currentCustomerName.textContent = 'Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©';
                customerDetails.innerHTML = '';
                messageInput.disabled = true;
                sendButton.disabled = true;
            }
        })
        .catch((error) => {
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©: ' + error.message);
            console.error("Error deleting conversation: ", error);
        });
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ù†ØµØ± Ø¹Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯
function updateCustomerItem(convId, convData) {
    const customerElement = document.getElementById(`customer-${convId}`);
    if (!customerElement) return;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©
    let hasNewMessages = false;
    if (convData.messages) {
        const messageKeys = Object.keys(convData.messages);
        if (messageKeys.length > 0) {
            const lastMessage = convData.messages[messageKeys[messageKeys.length - 1]];
            if (lastMessage.sender === 'customer' && !lastMessage.read) {
                hasNewMessages = true;
            }
        }
    }

    // Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø¨Ø¹Ø¯ 30 Ø¯Ù‚ÙŠÙ‚Ø©)
    const isCustomerOnline = convData.lastActive && (Date.now() - convData.lastActive < 30 * 60 * 1000);
    const statusClass = isCustomerOnline ? 'status-online' : 'status-offline';
    const statusText = isCustomerOnline ? 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†' : 'ØºÙŠØ± Ù…ØªØµÙ„';

    // Ø¥Ù†Ø´Ø§Ø¡ HTML Ø¬Ø¯ÙŠØ¯
    const customerInfo = customerElement.querySelector('.customer-info');
    if (customerInfo) {
        customerInfo.innerHTML = `
            <div class="customer-name">
                <span>${convData.customerName || 'Ø¹Ù…ÙŠÙ„ Ù…Ø¬Ù‡ÙˆÙ„'}</span>
                <span class="customer-status-badge ${statusClass}" title="${statusText}"></span>
            </div>
            <div class="customer-preview">${convData.lastMessage || 'Ø¨Ø¯Ø£Øª Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©'}</div>
            <div class="customer-time">
                <i class="far fa-clock"></i>
                ${formatTime(convData.lastActive || convData.startedAt)}
            </div>
        `;
    }

    // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const existingBadge = customerElement.querySelector('.new-message-badge');
    if (hasNewMessages && !existingBadge) {
        const badge = document.createElement('div');
        badge.className = 'new-message-badge';
        badge.innerHTML = '!';
        customerElement.appendChild(badge);
    } else if (!hasNewMessages && existingBadge) {
        existingBadge.remove();
    }
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffInHours = (now - date) / (1000 * 60 * 60);
    if (diffInHours < 1) {
        const diffInMinutes = Math.floor(diffInHours * 60);
        return `${diffInMinutes} Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø¶Øª`;
    } else if (diffInHours < 24) {
        return `${Math.floor(diffInHours)} Ø³Ø§Ø¹Ø© Ù…Ø¶Øª`;
    } else {
        return `${date.toLocaleDateString('ar-EG')}`;
    }
}

// Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§Ø¯Ø«Ø©
function selectConversation(convId, convData) {
    currentConversationId = convId;
    currentCustomerData = convData;
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.querySelectorAll('.customer-item').forEach(item => {
        item.classList.remove('active');
    });
    const customerElement = document.getElementById(`customer-${convId}`);
    if (customerElement) {
        customerElement.classList.add('active');
    }
    currentCustomerName.textContent = convData.customerName || 'Ø¹Ù…ÙŠÙ„ Ù…Ø¬Ù‡ÙˆÙ„';
    // ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„
    let detailsHTML = '';
    if (convData.customerPhone) {
        detailsHTML += `<div class="detail">
            <i class="fas fa-phone"></i>
            <a href="tel:${convData.customerPhone}">${convData.customerPhone}</a>
        </div>`;
    }
    detailsHTML += `<div class="detail">
        <i class="far fa-clock"></i>
        Ø¢Ø®Ø± Ù†Ø´Ø§Ø·: ${formatTime(convData.lastActive || convData.startedAt)}
    </div>`;
    customerDetails.innerHTML = detailsHTML;
    messageInput.disabled = false;
    sendButton.disabled = false;
    messageInput.focus();
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    loadMessages(convId);
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø¤Ø´Ø± ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„
    db.ref(`chat/conversations/${convId}/customerTyping`).on('value', (snapshot) => {
        const isTyping = snapshot.val() === true;
        typingIndicator.style.display = isTyping ? 'block' : 'none';
    });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function loadMessages(convId) {
    messagesArea.innerHTML = '';
    db.ref(`chat/conversations/${convId}/messages`).on('value', (snapshot) => {
        messagesArea.innerHTML = '';
        const messages = snapshot.val();
        if (messages) {
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© ÙˆÙØ±Ø²Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„ØªÙˆÙ‚ÙŠØª
            const sortedMessages = Object.entries(messages)
                .sort(([,a], [,b]) => a.timestamp - b.timestamp);
            sortedMessages.forEach(([msgId, message]) => {
                displayMessage(message, msgId);
                // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„
                if (message.sender === 'customer' && !message.read) {
                    db.ref(`chat/conversations/${convId}/messages/${msgId}`).update({
                        read: true
                    });
                }
            });
        }
    });
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ÙØ¹Ø§Ù„
    db.ref(`chat/conversations/${convId}/reactions`).on('value', (snapshot) => {
        const reactionsData = snapshot.val();
        if (reactionsData) {
            Object.keys(reactionsData).forEach(messageId => updateReactionsUI(messageId, reactionsData[messageId]));
        }
    });
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø¨Ø¯ÙˆÙ† ØªÙ…Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ)
function displayMessage(message, messageId) {
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§ÙˆÙŠ (wrapper) Ø§Ù„Ø°ÙŠ Ø³ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø±Ø¯
    const messageWrapper = document.createElement('div');
    messageWrapper.className = 'message-wrapper';
    messageWrapper.setAttribute('data-message-id', messageId);
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆÙƒØ³ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù†ÙØ³Ù‡
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.sender}`;
    if (message.type === 'location') {
        messageDiv.classList.add('location');
    }
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø±Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø£Ø®Ø±Ù‰ (ÙŠØ¸Ù‡Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨ÙˆÙƒØ³)
    if (message.replyTo) {
        const replyIndicator = document.createElement('div');
        replyIndicator.className = 'reply-indicator';
        replyIndicator.innerHTML = `<i class="fas fa-reply"></i> <span>Ø±Ø¯ Ø¹Ù„Ù‰: "${message.replyToText?.substring(0, 20) || 'Ø±Ø³Ø§Ù„Ø© Ø³Ø§Ø¨Ù‚Ø©'}"</span>`;
        messageDiv.appendChild(replyIndicator);
    }
    let messageContent;
    if (message.type === 'location') {
        messageContent = document.createElement('div');
        messageContent.className = 'location-message';
        const link = document.createElement('a');
        link.href = `https://www.google.com/maps?q=${message.latitude},${message.longitude}`;
        link.target = '_blank';
        link.textContent = `ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${message.latitude.toFixed(4)}, ${message.longitude.toFixed(4)}`;
        messageContent.appendChild(link);
    } else {
        messageContent = document.createElement('div');
        messageContent.className = 'message-text';
        messageContent.textContent = message.text;
    }
    const messageInfo = document.createElement('div');
    messageInfo.className = 'message-info';
    const date = new Date(message.timestamp);
    const timeStr = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    // ÙÙŠ message-infoØŒ Ù†Ø²ÙŠÙ„ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø±Ø¯ Ù…Ù† Ù‡Ù†Ø§ Ù„Ø£Ù†Ù‡Ø§ Ø³ØªØ¸Ù‡Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¨ÙˆÙƒØ³
    messageInfo.innerHTML = `
        <span>${timeStr}</span>
        ${message.sender === 'customer' ? '<i class="fas fa-check-double" style="color: #4CAF50;"></i>' : ''}
    `;
    // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø³Ù… Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ÙØ¹Ø§Ù„
    const reactionsDiv = document.createElement('div');
    reactionsDiv.className = 'message-reactions';
    reactionsDiv.setAttribute('data-message-id', messageId);
    // ØªØ¬Ù…ÙŠØ¹ Ù…Ø­ØªÙˆÙŠØ§Øª Ø¨ÙˆÙƒØ³ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    messageDiv.appendChild(messageContent);
    messageDiv.appendChild(messageInfo);
    messageDiv.appendChild(reactionsDiv);
    // Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆÙƒØ³ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙˆÙŠ
    messageWrapper.appendChild(messageDiv);
    // ======== Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø±Ø¯ Ø®Ø§Ø±Ø¬ Ø¨ÙˆÙƒØ³ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ========
    if (message.sender === 'customer') {
        const replyActionIcon = document.createElement('div');
        replyActionIcon.className = 'reply-action-icon';
        replyActionIcon.innerHTML = '<i class="fas fa-reply"></i>';
        replyActionIcon.title = 'Ø±Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©';
        replyActionIcon.setAttribute('data-message-id', messageId);
        replyActionIcon.setAttribute('data-sender', message.sender);
        replyActionIcon.setAttribute('data-text', encodeURIComponent(message.text || ''));
        // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø±
        replyActionIcon.addEventListener('click', (e) => {
            const target = e.currentTarget;
            setReplyTo(
                target.getAttribute('data-message-id'),
                target.getAttribute('data-sender'),
                decodeURIComponent(target.getAttribute('data-text'))
            );
        });
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙˆÙŠ Ø¨Ø¬Ø§Ù†Ø¨ Ø¨ÙˆÙƒØ³ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        messageWrapper.appendChild(replyActionIcon);
    }
    // ======== Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø±Ø¯ ========
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§ÙˆÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ (Ø§Ù„Ø±Ø³Ø§Ù„Ø© + Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©) Ø¥Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    messagesArea.appendChild(messageWrapper);
    // âŒ ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    // messagesArea.scrollTop = messagesArea.scrollHeight;
}

// ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£ÙØ¹Ø§Ù„
function updateReactionsUI(messageId, reactionsData) {
    const reactionsDiv = document.querySelector(`.message-reactions[data-message-id="${messageId}"]`);
    if (!reactionsDiv) return;
    reactionsDiv.innerHTML = '';
    Object.keys(reactionsData).forEach(reaction => {
        const count = reactionsData[reaction];
        const reactionEl = document.createElement('div');
        reactionEl.className = 'reaction';
        reactionEl.innerHTML = `${reaction} ${count > 1 ? count : ''}`;
        reactionsDiv.appendChild(reactionEl);
    });
}

// ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§
function setReplyTo(messageId, sender, text) {
    currentReplyTo = {
        messageId: messageId,
        sender: sender,
        text: text
    };
    replyPreviewText.textContent = `Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰: "${text.substring(0, 30)}${text.length > 30 ? '...' : ''}"`;
    replyPreview.classList.add('show');
}

// Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¯
cancelReply.addEventListener('click', () => {
    currentReplyTo = null;
    replyPreview.classList.remove('show');
});

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
function sendMessage() {
    const text = messageInput.value.trim();
    if (text && currentConversationId) {
        const message = {
            sender: 'admin',
            text: text,
            timestamp: Date.now(),
            read: false
        };
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©
        if (currentReplyTo) {
            message.replyTo = currentReplyTo.messageId;
            message.replyToText = currentReplyTo.text;
        }
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const newMessageRef = db.ref(`chat/conversations/${currentConversationId}/messages`).push(message);
        // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        db.ref(`chat/conversations/${currentConversationId}`).update({
            lastMessage: text,
            lastActive: Date.now()
        });
        // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø¯
        messageInput.value = '';
        currentReplyTo = null;
        replyPreview.classList.remove('show');
        messageInput.focus();
    }
}

// Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø²Ø± Ø£Ùˆ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
sendButton.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
let typingTimer;
messageInput.addEventListener('input', () => {
    if (currentConversationId) {
        db.ref(`chat/conversations/${currentConversationId}/adminTyping`).set(true);
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            db.ref(`chat/conversations/${currentConversationId}/adminTyping`).set(false);
        }, 2000);
    }
});

// Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±
function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
        color: var(--dark-bg);
        padding: 15px 25px;
        border-radius: 30px;
        font-weight: bold;
        z-index: 1000;
        box-shadow: 0 5px 15px rgba(212, 175, 55, 0.5);
        animation: slideIn 0.5s, fadeOut 0.5s 3s forwards;
    `;
    notification.innerHTML = `<i class="fas fa-bell"></i> ${message}`;
    document.body.appendChild(notification);
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3500);
}

// Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
loadConversations();
</script>
</body>
</html>